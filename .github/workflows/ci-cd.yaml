name: Advanced CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  APP_NAME: api-scanner
  DOCKER_REGISTRY: docker.io
  DOCKER_IMAGE: ${{ env.DOCKER_REGISTRY }}/your-dockerhub-username/${{ env.APP_NAME }}

jobs:
  # ------------------------------
  # 1️⃣ Build, Test, Lint & SAST
  # ------------------------------
  build-test-lint-sast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Cache pip
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install bandit pytest flake8 requests prometheus-client

      - name: Run unit tests
        run: pytest tests/ -v

      - name: Run linter (flake8)
        run: flake8 app/ main.py

      - name: Run SAST (Bandit)
        run: bandit -r app/ -lll

  # ------------------------------
  # 2️⃣ DAST + Metrics Check
  # ------------------------------
  dast-metrics:
    needs: build-test-lint-sast
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install -r requirements.txt requests

      - name: Start Flask app
        run: |
          nohup python main.py &
          sleep 5

      - name: Run basic DAST
        run: |
          python - <<EOF
import requests
url = "http://127.0.0.1:5000/scan"
payload = {"url": "http://example.com", "params": {}}
r = requests.post(url, json=payload, timeout=5)
assert r.status_code == 200
EOF

      - name: Check Prometheus metrics endpoint
        run: |
          curl -f http://127.0.0.1:5000/metrics || exit 1

  # ------------------------------
  # 3️⃣ Docker Build + Versioning + Push
  # ------------------------------
  docker-build-push:
    needs: dast-metrics
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Get version tag
        id: vars
        run: |
          VERSION=$(date +%Y%m%d%H%M%S)
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Build Docker image
        run: docker build -t ${{ env.DOCKER_IMAGE }}:${{ env.VERSION }} .

      - name: Push Docker image
        run: docker push ${{ env.DOCKER_IMAGE }}:${{ env.VERSION }}

      - name: Tag latest
        run: docker tag ${{ env.DOCKER_IMAGE }}:${{ env.VERSION }} ${{ env.DOCKER_IMAGE }}:latest && docker push ${{ env.DOCKER_IMAGE }}:latest

  # ------------------------------
  # 4️⃣ Kubernetes Deployment
  # ------------------------------
  deploy:
    needs: docker-build-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.28.0'

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f k8s/deployment.yaml
          kubectl apply -f k8s/service.yaml
          kubectl rollout status deployment/api-scanner

